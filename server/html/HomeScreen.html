<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <title>OP</title>
    <!-- Custom fonts for this template -->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css" />
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet" />
    <!-- Custom styles for this template -->
    <link href="css/sb-admin-2.min.css" rel="stylesheet" />

    <!-- Custom styles for this page -->
    <link href="vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet" />
</head>

<body id="page-top">
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabell"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-row">
                            <div class="col">
                                <input type="text" class="form-control" id="Inputgpc">
                            </div>
                            <div class="col">
                                <input type="text" class="form-control" id="Inputdescgpc">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="SendUpdate(this)">Save changes</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Page Wrapper -->
    <div class="modal fade" id="Modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ModalLabel">Cadastro</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-row">
                            <div class="col">
                                <input type="text" class="form-control" placeholder="NCM" id="Inputmodalncm">
                            </div>
                            <div class="col">
                                <input type="text" class="form-control" placeholder="DESCRIÇÃO NCM"
                                    id="Inputmodaldescncm">
                            </div>
                        </div>
                        <div class="m-2"></div>
                        <div class="form-row">
                            <div class="col">
                                <input type="text" class="form-control" placeholder="GPC" id="Inputmodalgpc">
                            </div>
                            <div class="col">
                                <input type="text" class="form-control" placeholder="DESCRIÇÃO GPC"
                                    id="Inputmodaldescgpc">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="SendInsert()">Save changes</button>
                </div>
            </div>
        </div>
    </div>
    <div id="wrapper">
        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">
            <!-- Main Content -->
            <div id="content">
                <!-- Begin Page Content -->
                <div class="container-fluid">
                    <!-- DataTales Example -->
                    <div class="card  mb-4">
                        <div class=" card-header py-3">
                            <div class="justify-content-between row">
                                <div class="justify-content-start row">
                                    <div class="col-auto">
                                        <input type="" id="inputop" class="form-control"
                                            aria-describedby="passwordHelpInline">
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="findallOP()" id="selectop">
                                        Pesquisar OP
                                    </button>
                                </div>
                                <button type="button " class="btn btn-success " onclick="downloadFile() "
                                    id="buttonExcel ">
                                    Baixar Excel
                                </button>
                            </div>

                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                                    <thead>
                                        <tr id="tr">
                                            <th data-field="image">Image</th>
                                            <th data-field="ref">Referência</th>
                                            <th data-field="ean">Ean-13</th>
                                            <th data-field="nome">Nome</th>
                                            <th data-field="cor">cor</th>
                                            <th data-field="tamanho">Tam</th>
                                            <th data-field="unidade">UN</th>
                                            <th data-field="quantidade">Qtd</th>
                                            <th data-field="extra1">Extra 1</th>
                                            <th data-field="extra2">Extra 2</th>
                                            <th data-field="Extra20">Extra 20</th>
                                            <th data-field="grupo">Grupo</th>
                                        </tr>
                                    </thead>
                                    <tfoot>
                                        <tr id="tr"></tr>
                                    </tfoot>
                                    <tbody id="tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /.container-fluid -->
            </div>

            <!-- Footer -->
            <footer class="sticky-footer bg-white">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>Desenvolvimento - (Lucca.galhato@tbfg.com.br) &copy; Manchester 2021</span>
                    </div>
                </div>
            </footer>
            <!-- End of Footer -->
        </div>
        <!-- End of Content Wrapper -->
    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    <!-- Logout Modal-->
    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ready to Leave?</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    Select "Logout" below if you are ready to end your current session.
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-dismiss="modal">
                        Cancel
                    </button>
                    <a class="btn btn-primary" href="login.html">Logout</a>
                </div>
            </div>
        </div>
    </div>
    <style>
        .custom-file-upload {
            border: 1px solid #ccc;
            display: inline-block;
            padding: 6px 12px;
            cursor: pointer;
        }

        input[type="file"] {
            display: none;
        }

        img {
            max-height: 100px;
            margin-left: auto;
            margin-right: auto;
            display: block;
        }
    </style>
    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.min.js"></script>

    <!-- Page level plugins -->
    <script src="vendor/datatables/jquery.dataTables.min.js"></script>
    <script src="vendor/datatables/dataTables.bootstrap4.min.js"></script>

    <!-- Page level custom scripts -->
    <script src="js/demo/datatables-demo.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.js"></script>
    <script>
        $('#myModal').on('shown.bs.modal',
            function () {
                $('#myInput').trigger('focus')
            }
        )
        var $table = $("#dataTable").DataTable({
            "columnDefs": [
                { "width": "15%", "targets": 3 }
            ]
        });
        let username = localStorage.getItem("Username")
        // await username.set("Username", localStorage.getItem("Username"))

        function headers() {
            var h = new Headers()
            h.set("Token", localStorage.getItem("Token"))
            return h
        }
        let idexcel;

        async function findallOP() {
            var op = document.getElementById("inputop").value
            console.log(op);
            if (op != null && op != "") {
                var cod = {
                    "cod": op
                };
                var body = JSON.stringify(cod);
                var myInit = {
                    method: "POST",
                    headers: headers(),
                    mode: "cors",
                    cache: "default",
                    body: body,
                }
                const response = await fetch(`${window.location.protocol}//${window.location.host}/selectop`, myInit);
                const blob = await response.blob();
                const text = await blob.text();
                const data = JSON.parse(text);

                if (data.Status != "OK") {
                    console.log("Error", data.Error);
                    return alert("OP Não encontrada")
                } else {
                    // removeAllChildNodes(document.getElementById("tbody"))
                    let OPS = data.Data;
                    idexcel = data.Id;
                    var rows = [];
                    OPS.forEach((item, index) => {
                        rows.push([item.referencia, item.ean13, item.nome, item.cor, item.tamanho, item.unidade, item.quantidade, item.extra1, item.extra2, item.extra20, item.grupo]);
                    });
                    $table.clear().draw();
                    // $table.rows.remove().draw();
                    $table.rows.add(rows).draw();
                    return;
                }

            }
            return alert("Favor inserir OP");
        }
        // document.getElementById("Inputmodalncm").addEventListener('focusout', async function(e) {
        //     await SelectOP(e.target.value)
        // });

        async function downloadFile() {
            if (idexcel != null) {
                var cod = {
                    "cod": idexcel
                };
                var body = JSON.stringify(cod);
                var myInit = {
                    method: "POST",
                    headers: headers(),
                    mode: "cors",
                    cache: "default",
                    body: body,
                };
<<<<<<< HEAD
                var response = await fetch(
                    `
                    $ {
                        window.location.protocol
                    } //${window.location.host}/id`,
                    myInit
                );
                var myBlob = await response.blob();
=======
                const response = await fetch(`${window.location.protocol}//${window.location.host}/selectop`, myInit);
                const blob = await response.blob();
                const text = await blob.text();
                const data = JSON.parse(text);

                if (data.Status != "OK") {
                    // console.log("Error", data.Error);
                    alert(data.Data);
                    return;
                }
                // removeAllChildNodes(document.getElementById("tbody"))
                let OPS = data.Data;
                xlsxData = data.Excel;
                var rows = [];
                OPS.forEach((item, index) => {
                    rows.push([`<img src=\"https://api.boxdelivery.tbfg.com.br:11900/photos/${item.referencia}.jpeg" alt="${item.referencia}">`, item.referencia, item.ean13, item.nome, item.cor, item.tamanho, item.unidade, item.quantidade, item.extra1, item.extra2, item.extra20, item.grupo]);
                });
                $table.rows.add(rows).draw();
                return
            }
            alert("Favor inserir OP");
        }
        // document.getElementById("Inputmodalncm").addEventListener('focusout', async function(e) {
        //     await SelectOP(e.target.value)
        // });

        function toBlob(b64) {
            const byteCharacters = atob(b64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: 'audio/mp3' });
        }

        async function downloadFile() {
            if (xlsxData != null) {
                var myBlob = toBlob(xlsxData);
>>>>>>> 7897d28 (.)
                var a = document.createElement("a");
                var url = window.URL.createObjectURL(myBlob);
                a.href = url;
                var filename = response.headers.get("File-Name");
                a.download = filename || "data.xlsx";
                this.console.log(filename);
                a.click();
                a.remove();
                var load = document.getElementById("load");
                var btnenviar = document.getElementById("btnenviar");
                btnenviar.setAttribute(
                    "class",
                    "row justify-content-center align-items-center"
                );
                load.setAttribute(
                    "class",
                    "row justify-content-center align-items-center d-none"
                );
                alert("Download Concluído");
                window.URL.revokeObjectURL(url);
            }
        }



        // async function Insert(body) {
        //     var myInit = {
        //         method: "POST",
        //         headers: headers(),
        //         mode: "cors",
        //         cache: "default",
        //         body: body,
        //     };
        //     const response = await fetch(`${window.location.protocol}//${window.location.host}/insert`, myInit);
        //     const blob = await response.blob();
        //     const text = await blob.text();
        //     const data = JSON.parse(text);
        //     if (data.Status != "OK") {
        //         console.log("Error", data.Error);
        //         return;
        //     } else {
        //         location.assign(`${window.location.protocol}//${window.location.host}/html/HomeScreen.html`)
        //     }
        // }

        // async function SendInsert() {
        //     ncm = document.getElementById("Inputmodalncm").value;
        //     desc_ncm = document.getElementById("Inputmodaldescncm").value;
        //     desc_ncm = desc
        //     gpc = document.getElementById("Inputmodalgpc").value;
        //     desc_gpc = document.getElementById("Inputmodaldescgpc").value;
        //     var values = {
        //         "values": [ncm, desc_ncm, gpc, desc_gpc],
        //         "username": username
        //     };
        //     var data = JSON.stringify(values);
        //     Insert(data);
        // }
        // async function Delete(body) {
        //     var myInit = {
        //         method: "POST",
        //         headers: headers(),
        //         mode: "cors",
        //         cache: "default",
        //         body: body,
        //     };
        //     const response = await fetch(`${window.location.protocol}//${window.location.host}/delete`, myInit);
        //     const blob = await response.blob();
        //     const text = await blob.text();
        //     const data = JSON.parse(text);
        //     if (data.Status != "OK") {
        //         console.log("Error", data.Error);
        //         return;
        //     } else {
        //         location.assign(`${window.location.protocol}//${window.location.host}/html/HomeScreen.html`)
        //     }
        // }

        // function SendDelete(ncm, gpc, desc_gpc) {
        //     data = (ncm.parentElement.parentElement.parentElement.children[0].textContent)
        //     var values = {
        //         "id": [data]
        //     };
        //     var data = JSON.stringify(values);
        //     Delete(data);
        // }
        // async function Update(body) {
        //     var myInit = {
        //         method: "POST",
        //         headers: headers(),
        //         mode: "cors",
        //         cache: "default",
        //         body: body,
        //     };
        //     const response = await fetch(`${window.location.protocol}//${window.location.host}/update`, myInit);
        //     const blob = await response.blob();
        //     const text = await blob.text();
        //     const data = JSON.parse(text);
        //     if (data.Status != "OK") {
        //         console.log("Error", data.Error);
        //         return;
        //     } else {
        //         location.assign(`${window.location.protocol}//${window.location.host}/html/HomeScreen.html`)
        //     }
        // }

        // function createSendUpdate(element) {
        //     ncm = (element.parentElement.parentElement.parentElement.children[0].textContent);
        //     desc_ncm = (element.parentElement.parentElement.parentElement.children[1].textContent);
        //     gpc = (element.parentElement.parentElement.parentElement.children[2].textContent);
        //     desc_gpc = (element.parentElement.parentElement.parentElement.children[3].textContent);
        //     document.getElementById("exampleModalLabell").innerHTML = "NCM:" + ncm + "-" + desc_ncm
        //     gpctitle = document.getElementById("Inputgpc")
        //     desc_gpctitle = document.getElementById("Inputdescgpc")
        //     gpctitle.setAttribute("placeholder", gpc)
        //     desc_gpctitle.setAttribute("placeholder", desc_gpc)
        //     SendUpdate = function() {
        //         ncm = (element.parentElement.parentElement.parentElement.children[0].textContent);
        //         gpc = document.getElementById("Inputgpc").value
        //         desc_gpc = document.getElementById("Inputdescgpc").value
        //         if (gpc != null && desc_gpc != "") {
        //             var values = {
        //                 "columns": [{
        //                     "name": "GPC",
        //                     "value": gpc
        //                 }, {
        //                     "name": "DESC_GPC",
        //                     "value": desc_gpc
        //                 }],
        //                 "condition": ncm,
        //                 "username": username
        //             }
        //         } else if (desc_gpc == "") {
        //             var values = {
        //                 "columns": [{
        //                     "name": "GPC",
        //                     "value": gpc
        //                 }],
        //                 "condition": ncm,
        //                 "username": username
        //             }
        //         } else if (gpc == "") {
        //             var values = {
        //                 "columns": [{
        //                     "name": "DESC_GPC",
        //                     "value": desc_gpc
        //                 }],
        //                 "condition": ncm,
        //                 "username": username
        //             }
        //         } else {
        //             alert("Por favor Inserir dados")
        //             return
        //         }
        //         var data = JSON.stringify(values);
        //         console.log(data)
        //         Update(data);
        //     }
        // }

        // function SendUpdate() {}
    </script>
</body>

</html>